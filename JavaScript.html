<script>
    let STATE = { user: null, projects: [], tasks: [], finance: [], assets: [], clients: [], users: [], logs: [], comments: [] };
    let CURRENT_PROJECT_ID = null;
    let CURRENT_PAGE = 'dashboard';
    let currentType = '';
    let currentEditId = null;

    // --- CORE UTILITIES ---
    function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        if (!container) return;
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        const icon = type === 'error' ? 'times-circle' : (type === 'warning' ? 'exclamation-triangle' : 'check-circle');
        toast.innerHTML = `<i class="fas fa-${icon}"></i><span>HỆ THỐNG: ${message}</span>`;
        container.appendChild(toast);
        toast.onclick = () => toast.remove();
        setTimeout(() => { if (toast.parentNode) toast.remove(); }, 4000);
    }

    function updateProjectProgress(projectId) {
        const pTasks = STATE.tasks.filter(t => t.ProjectID === projectId);
        if (pTasks.length === 0) return;
        const done = pTasks.filter(t => t.TrangThai === 'Done').length;
        const percent = Math.round((done / pTasks.length) * 100);
        const p = STATE.projects.find(x => x.ID === projectId);
        if (p && p.TienDo != percent) {
            p.TienDo = percent;
            if (percent === 100) p.TrangThai = 'Hoàn tất';
            google.script.run.withSuccessHandler(data => {
                STATE = { ...STATE, ...data };
                showToast(`Đã tự động cập nhật tiến độ dự án: ${percent}%`);
            }).saveData('project', p);
        }
    }

    function updateNotifications() {
        const bell = document.getElementById('noti-bell');
        if (!bell) return;
        const today = new Date().toISOString().split('T')[0];
        const overdue = STATE.tasks.filter(t => t.Deadline && t.Deadline < today && t.TrangThai !== 'Done');
        if (overdue.length > 0) {
            bell.innerHTML = `<i class="fas fa-bell pulse-animation" style="color:var(--accent-magenta)"></i><span class="badge-pulse" style="position:absolute; top:-5px; right:-5px; background:var(--accent-magenta); color:white; font-size:10px; padding:2px 5px; border-radius:50%">${overdue.length}</span>`;
        } else {
            bell.innerHTML = `<i class="fas fa-bell"></i>`;
        }
    }

    // 1. MOBILE SIDEBAR
    function toggleSidebar(force) {
        const sb = document.getElementById('sidebar');
        const ov = document.querySelector('.sidebar-overlay');
        if (force === undefined) {
            sb.classList.toggle('active');
            ov.classList.toggle('active');
        } else {
            if (force) { sb.classList.add('active'); ov.classList.add('active'); }
            else { sb.classList.remove('active'); ov.classList.remove('active'); }
        }
    }

    // 2. SEARCH ENGINE
    function handleSearch(keyword) {
        keyword = keyword.toLowerCase();
        // search logic depends on current page
        if (CURRENT_PAGE === 'projects') {
            const filtered = STATE.projects.filter(p => p.Ten.toLowerCase().includes(keyword) || (p.QuanLy && p.QuanLy.toLowerCase().includes(keyword)));
            renderProjects(filtered);
        } else if (CURRENT_PAGE === 'finance') {
            const filtered = STATE.finance.filter(f => f.NoiDung.toLowerCase().includes(keyword));
            renderFinance(filtered);
        } else if (CURRENT_PAGE === 'assets') {
            const filtered = STATE.assets.filter(a => a.TenTS.toLowerCase().includes(keyword));
            renderAssets(filtered);
        } else if (CURRENT_PAGE === 'clients') {
            const filtered = STATE.clients.filter(c => c.TenKH.toLowerCase().includes(keyword));
            renderClients(filtered);
        }
        // Add more as needed
    }

    // 3. CORE LOGIC
    function handleLogin(e) {
        e.preventDefault();
        const btn = document.getElementById('btn-login');
        const err = document.getElementById('login-error');
        const email = document.getElementById('log-email').value;
        const pass = document.getElementById('log-pass').value;

        btn.innerHTML = '<i class="fas fa-sync fa-spin"></i> ĐANG XÁC THỰC...';
        btn.disabled = true;
        err.style.display = 'none';

        google.script.run.withSuccessHandler(user => {
            STATE.user = user;
            document.getElementById('view-login').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('view-login').style.display = 'none';
                document.getElementById('view-app').style.display = 'block';
                document.getElementById('view-app').style.animation = 'fadeIn 0.5s ease-out';
            }, 300);

            document.getElementById('user-info').innerHTML = `
                <img src="${user.avatar || 'https://ui-avatars.com/api/?name=U&background=00f2ff&color=000'}" class="user-avatar">
                <div>
                    <div style="font-weight:700; font-size:0.9rem; color:#fff">${user.name}</div>
                    <div style="font-size:0.7rem; color:var(--accent-cyan); text-transform:uppercase">${user.role}</div>
                </div>`;

            loadData();
        }).withFailureHandler(error => {
            btn.innerHTML = 'TRUY CẬP HỆ THỐNG';
            btn.disabled = false;
            err.innerText = "TRUY CẬP BỊ TỪ CHỐI: " + error.message;
            err.style.display = 'block';
        }).loginSystem(email, pass);
    }

    // 2. TẢI DỮ LIỆU
    function loadData() {
        const content = document.getElementById('content-area');
        content.innerHTML = `
            <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; color:var(--accent-cyan)">
                <i class="fas fa-atom fa-spin fa-3x" style="margin-bottom:20px; text-shadow:var(--neon-shadow-cyan)"></i>
                <div style="font-family:'Orbitron'; letter-spacing:2px">ĐANG TẢI HỆ THỐNG QUẢN TRỊ DỰ ÁN...</div>
            </div>`;

        google.script.run.withSuccessHandler(data => {
            STATE = { ...STATE, ...data };
            renderDashboard();
        }).getInitialData();
    }

    // 3. CHUYỂN TRANG
    function switchPage(page, el) {
        document.querySelectorAll('.nav-menu li').forEach(li => li.classList.remove('active'));
        if (el) el.classList.add('active');

        const content = document.getElementById('content-area');
        const title = document.getElementById('page-title');
        const btnAction = document.getElementById('btn-main-action');

        content.style.opacity = '0';
        setTimeout(() => {
            CURRENT_PROJECT_ID = null;
            if (page === 'dashboard') {
                title.innerText = "BÀN ĐIỀU KHIỂN DỰ ÁN";
                renderDashboard();
                btnAction.style.display = 'none';
            } else {
                btnAction.style.display = 'block';
                if (page === 'projects') {
                    title.innerText = "DANH SÁCH BLUEPRINTS (DỰ ÁN)";
                    btnAction.innerText = "+ KHỞI TẠO DỰ ÁN";
                    btnAction.onclick = () => openModal('project');
                    renderProjects();
                }
                else if (page === 'kanban') {
                    title.innerText = "MA TRẬN CÔNG VIỆC (KANBAN)";
                    btnAction.innerText = "+ THÊM NHIỆM VỤ";
                    btnAction.onclick = () => openModal('task');
                    renderKanban();
                }
                else if (page === 'finance') {
                    title.innerText = "CHI PHÍ & NGÂN SÁCH DỰ ÁN";
                    btnAction.innerText = "+ NHẬP CHI PHÍ";
                    btnAction.onclick = () => openModal('finance');
                    renderFinance();
                }
                else if (page === 'assets') {
                    title.innerText = "NGUỒN LỰC & THIẾT BỊ";
                    btnAction.innerText = "+ THÊM NGUỒN LỰC";
                    btnAction.onclick = () => openModal('asset');
                    renderAssets();
                }
                else if (page === 'clients') {
                    title.innerText = "ĐỐI TÁC & CHỦ ĐẦU TƯ";
                    btnAction.innerText = "+ THÊM ĐỐI TÁC";
                    btnAction.onclick = () => openModal('client');
                    renderClients();
                }
                else if (page === 'users') {
                    title.innerText = "ĐỘI NGŨ NHÂN SỰ (AGENTS)";
                    btnAction.style.display = 'none';
                    renderUsers();
                }
                else if (page === 'logs') {
                    title.innerText = "NHẬT KÝ HỆ THỐNG (SYSTEM LOGS)";
                    btnAction.style.display = 'none';
                    renderLogs();
                }
                else if (page === 'reports') {
                    title.innerText = "BÁO CÁO CHIẾN LƯỢC (REPORTS ENGINE)";
                    btnAction.innerText = "+ XUẤT BÁO CÁO TỔNG HỢP";
                    btnAction.onclick = () => generateGlobalReport();
                    renderReports();
                }
            }
            content.style.opacity = '1';
            content.style.transition = '0.3s';
        }, 150);
    }

    // 4. RENDER DÀNH RIÊNG CHO PROJECT MANAGEMENT
    function renderDashboard() {
        const totalProjects = STATE.projects.length;
        const activeTasks = STATE.tasks.filter(t => t.TrangThai !== 'Done').length;
        const completionRate = totalProjects > 0 ? (STATE.projects.filter(p => p.TienDo == 100).length / totalProjects * 100).toFixed(0) : 0;

        // Render Dashboard Base
        document.getElementById('content-area').innerHTML = `
            <div class="stats-container">
                <div class="neon-card stagger-item">
                    <div class="stat-label">Tổng số dự án</div>
                    <div class="stat-val count-up" style="color:var(--accent-cyan)">${totalProjects}</div>
                </div>
                <div class="neon-card stagger-item">
                    <div class="stat-label">Nhiệm vụ đang chạy</div>
                    <div class="stat-val count-up" style="color:var(--accent-magenta)">${activeTasks}</div>
                </div>
                <div class="neon-card stagger-item">
                    <div class="stat-label">Hiệu suất trung bình</div>
                    <div class="stat-val count-up" style="color:var(--accent-lime)">${completionRate}%</div>
                </div>
            </div>
            
            <div style="display:grid; grid-template-columns: 1.5fr 1fr; gap:30px; margin-bottom:30px;">
                <div class="neon-card stagger-item" style="height:380px">
                    <div class="stat-label" style="margin-bottom:20px">Biểu Đồ Phân Bổ Dự Án</div>
                    <canvas id="chartProjects"></canvas>
                </div>
                <div class="neon-card stagger-item" style="height:380px; overflow-y:auto;">
                    <div class="stat-label" style="margin-bottom:20px; display:flex; justify-content:space-between; align-items:center;">
                        <span>Phân Tích Thông Minh (Gemini AI)</span>
                        <i class="fas fa-magic" style="color:var(--accent-cyan); animation: pulse 2s infinite"></i>
                    </div>
                    <div id="insights-list">
                        <div style="color:var(--text-dim); text-align:center; padding-top:100px;">
                            <i class="fas fa-brain fa-spin" style="font-size:2rem; margin-bottom:15px; color:var(--accent-cyan)"></i>
                            <div>AI đang phân tích dữ liệu...</div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="dashboard-bottom">
                <div class="neon-card stagger-item">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px">
                        <div class="stat-label">Dự Án Trọng Điểm Đang Hoạt Động</div>
                        <button class="btn-ghost" onclick="switchPage('projects')">Xem tất cả</button>
                    </div>
                    <table class="neon-table">
                        <thead><tr><th>Dự Án</th><th>Người Phụ Trách</th><th>Tiến Độ</th><th>Trạng Thái</th></tr></thead>
                        <tbody>
                            ${STATE.projects.slice(0, 5).map(p => `
                                    <tr onclick="viewProjectDetail('${p.ID}')" style="cursor:pointer">
                                        <td style="color:#fff; font-weight:600">${p.Ten}</td>
                                        <td style="color:var(--text-dim)">${p.QuanLy}</td>
                                        <td>
                                            <div class="prog-bar" style="width:120px; margin:0">
                                                <div class="prog-fill" style="width:${p.TienDo}%; background:var(--accent-cyan)"></div>
                                            </div>
                                        </td>
                                        <td><span style="color:var(--accent-cyan); text-transform:uppercase; font-size:0.75rem">${p.TrangThai}</span></td>
                                    </tr>
                                `).join('') || '<tr><td colspan="4">Không có dự án nào trong hệ thống.</td></tr>'}
                        </tbody>
                    </table>
                </div>
            </div>
        `;

        // Load AI Insights
        google.script.run.withSuccessHandler(aiInsights => {
            const list = document.getElementById('insights-list');
            if (!list) return;
            list.innerHTML = aiInsights.map(ins => `
                <div style="display:flex; gap:15px; margin-bottom:15px; padding:15px; background:rgba(255,255,255,0.03); border-left:4px solid ${ins.level === 'HIGH' ? 'var(--accent-magenta)' : (ins.level === 'MEDIUM' ? 'var(--accent-cyan)' : 'var(--accent-lime)')}">
                    <i class="fas fa-${ins.icon || 'info-circle'}" style="color:${ins.level === 'HIGH' ? 'var(--accent-magenta)' : (ins.level === 'MEDIUM' ? 'var(--accent-cyan)' : 'var(--accent-lime)')}; font-size:1.2rem; margin-top:2px"></i>
                    <div>
                        <div style="font-weight:700; font-size:0.75rem; color:var(--accent-cyan); margin-bottom:5px; text-transform:uppercase">${ins.title}</div>
                        <span style="font-size:0.85rem; color:var(--text-primary)">${ins.text}</span>
                    </div>
                </div>`).join('');
        }).runAIAnalysis();

        setTimeout(() => {
            const chartEl = document.getElementById('chartProjects');
            if (!chartEl) return;
            new Chart(chartEl, {
                type: 'doughnut',
                data: {
                    labels: ['Mới', 'Đang thực hiện', 'Hoàn tất', 'Tạm dừng'],
                    datasets: [{
                        data: [
                            STATE.projects.filter(p => p.TrangThai === 'Mới').length,
                            STATE.projects.filter(p => p.TrangThai === 'Đang làm').length,
                            STATE.projects.filter(p => p.TrangThai === 'Hoàn tất').length,
                            STATE.projects.filter(p => p.TrangThai === 'Tạm dừng').length
                        ],
                        backgroundColor: ['#00f2ff', '#bcff00', '#ff00ff', '#8485b1'],
                        borderWidth: 0,
                        hoverOffset: 15
                    }]
                },
                options: {
                    cutout: '70%',
                    plugins: { legend: { position: 'bottom', labels: { color: '#8485b1', padding: 20, font: { size: 10 } } } }
                }
            });
        }, 100);
    }

    function renderProjects() {
        let html = `<div style="display:flex; justify-content:flex-end; margin-bottom:20px;">
            <button class="btn-ghost" onclick="exportToCSV(STATE.projects, 'AFS_Projects')"><i class="fas fa-file-export"></i> Xuất Dữ Liệu Dân Sự</button>
        </div>
        <div class="project-grid">`;
        STATE.projects.forEach(p => {
            html += `
            <div class="neon-card stagger-item" onclick="viewProjectDetail('${p.ID}')" style="cursor:pointer">
                <div style="display:flex; justify-content:space-between; align-items:start">
                    <h3 style="color:#fff; margin-bottom:10px">${p.Ten}</h3>
                    <div style="font-size:0.7rem; color:var(--accent-magenta); border:1px solid var(--accent-magenta); padding:2px 6px; border-radius:4px; text-transform:uppercase">${p.TrangThai}</div>
                </div>
                <p style="color:var(--text-dim); font-size:0.85rem; height:40px; overflow:hidden; margin:10px 0;">${p.MoTa || 'Hệ thống chưa ghi nhận mô tả cho dự án này.'}</p>
                <div style="margin-top:20px;">
                    <div style="display:flex; justify-content:space-between; font-size:0.75rem; margin-bottom:8px">
                        <span style="color:var(--accent-cyan)"><i class="fas fa-user-astronaut"></i> ${p.QuanLy}</span>
                        <span style="color:#fff">${p.TienDo || 0}%</span>
                    </div>
                    <div class="prog-bar">
                        <div class="prog-fill" style="width:${p.TienDo || 0}%; background:linear-gradient(90deg, var(--accent-cyan), var(--accent-magenta))"></div>
                    </div>
                </div>
                <div style="margin-top:15px; display:flex; justify-content:space-between; align-items:center;">
                    <span style="font-size:0.7rem; color:var(--text-dim)"><i class="fas fa-calendar-alt"></i> ${p.KetThuc}</span>
                    <div style="display:flex; gap:10px;">
                        ${p.TaiLieu ? `<i class="fas fa-paperclip" style="color:var(--accent-cyan)"></i>` : ''}
                        <i class="fas fa-comments" style="color:var(--text-dim)"></i>
                    </div>
                </div>
            </div>`;
        });
        document.getElementById('content-area').innerHTML = html + "</div>" || "<div class='neon-card'>HỆ THỐNG TRỐNG: Vui lòng khởi tạo dự án đầu tiên.</div>";
    }

    function viewProjectDetail(id) {
        let p = STATE.projects.find(x => x.ID === id);
        if (!p) return;
        CURRENT_PROJECT_ID = id;
        const title = document.getElementById('page-title');
        title.innerHTML = `<i class="fas fa-arrow-left" onclick="switchPage('projects')" style="cursor:pointer; margin-right:15px"></i> PROJECT: ${p.Ten}`;
        const projectTasks = STATE.tasks.filter(t => t.ProjectID === id);
        const projectFinance = STATE.finance.filter(f => f.DoiTuong === p.Ten || f.NoiDung.includes(p.Ten));

        document.getElementById('content-area').innerHTML = `
            <div style="display:grid; grid-template-columns: 1fr 2fr; gap:30px;">
                <!-- Left: Info -->
                <div class="stagger-item">
                    <div class="neon-card" style="margin-bottom:30px">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px">
                            <div class="stat-label">Tiến Độ Cốt Lõi</div>
                            <i class="fas fa-edit" style="cursor:pointer; color:var(--accent-cyan)" onclick="openModal('project', '${p.ID}', true)"></i>
                        </div>
                        <div class="stat-val" style="color:var(--accent-cyan); font-size:3.5rem; text-align:center;">${p.TienDo}%</div>
                        <div class="prog-bar"><div class="prog-fill" style="width:${p.TienDo}%; background:var(--accent-cyan)"></div></div>
                        <div style="margin-top:25px; font-size:0.85rem; line-height:1.8">
                            <div style="display:flex; justify-content:space-between"><span style="color:var(--text-dim)">Người Phụ Trách:</span> <span style="color:#fff">${p.QuanLy}</span></div>
                            <div style="display:flex; justify-content:space-between"><span style="color:var(--text-dim)">Ngày Bắt Đầu:</span> <span style="color:#fff">${p.BatDau}</span></div>
                            <div style="display:flex; justify-content:space-between"><span style="color:var(--text-dim)">Ngày Kết Thúc:</span> <span style="color:#fff">${p.KetThuc}</span></div>
                            <div style="display:flex; justify-content:space-between"><span style="color:var(--text-dim)">Trạng Thái:</span> <span style="color:var(--accent-magenta); text-transform:uppercase">${p.TrangThai}</span></div>
                            ${p.TaiLieu ? `<div style="margin-top:15px; padding-top:15px; border-top:1px solid var(--glass)"><a href="${p.TaiLieu}" target="_blank" style="color:var(--accent-cyan); text-decoration:none;"><i class="fas fa-external-link-alt"></i> Tài Liệu Đính Kèm</a></div>` : ''}
                        </div>
                    </div>
                    <div class="neon-card">
                        <div class="stat-label">Mô Tả Nhiệm Vụ</div>
                        <p style="color:var(--text-dim); margin-top:15px; font-size:0.9rem; line-height:1.6">${p.MoTa || 'Không có mô tả chi tiết.'}</p>
                    </div>
                </div>
                
                <!-- Right: Units & Bio-Finance -->
                <div class="stagger-item">
                    <div class="neon-card" style="margin-bottom:30px">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px">
                            <div class="stat-label">Đơn Vị Thực Thi</div>
                            <div style="display:flex; gap:10px">
                                <button class="btn-ghost" onclick="openChatModal('${id}')"><i class="fas fa-comments"></i> THẢO LUẬN</button>
                                <button class="btn-create" onclick="openModal('task', '${id}')" style="padding:5px 15px; font-size:0.7rem">+ THÊM NHIỆM VỤ</button>
                            </div>
                        </div>
                        <table class="neon-table">
                            <thead><tr><th>Tên Công Việc</th><th>Nhân Sự</th><th>Trạng Thái</th><th>Trao Đổi</th></tr></thead>
                            <tbody>
                                ${projectTasks.map(t => `
                                    <tr>
                                        <td style="color:#fff">${t.Ten}</td>
                                        <td>${t.NguoiLam}</td>
                                        <td><span style="color:${t.TrangThai === 'Done' ? 'var(--accent-lime)' : 'var(--accent-magenta)'}">${t.TrangThai}</span></td>
                                        <td><i class="fas fa-comment-dots" style="cursor:pointer; color:var(--text-dim)" onclick="openChatModal('${t.ID}')"></i></td>
                                    </tr>
                                `).join('') || '<tr><td colspan="4">Chưa có nhiệm vụ nào được triển khai.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="neon-card">
                         <div class="stat-label" style="margin-bottom:20px">Phân Bổ Nguồn Lực Tài Chính</div>
                         <table class="neon-table">
                            <thead><tr><th>Nội Dung</th><th>Số Tiền</th><th>Loại</th></tr></thead>
                            <tbody>
                                ${projectFinance.map(f => `
                                    <tr>
                                        <td>${f.NoiDung}</td>
                                        <td style="color:${f.Loai === 'Thu' ? 'var(--accent-lime)' : 'var(--accent-magenta)'}">${Number(f.SoTien).toLocaleString()} Ȼ</td>
                                        <td>${f.Loai === 'Thu' ? 'THU' : 'CHI'}</td>
                                    </tr>
                                `).join('') || '<tr><td colspan="3">Chưa có phát sinh tài chính.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
    }

    function openChatModal(id) {
        document.getElementById('modal').style.display = 'flex';
        const h = document.getElementById('modal-heading');
        const b = document.getElementById('modal-body');
        const btnSave = document.getElementById('btn-save');
        currentType = 'comment';
        currentEditId = id; // Parent ID
        h.innerText = "TRUNG TÂM THẢO LUẬN & GIAO TIẾP";
        btnSave.innerText = "GỬI PHẢN HỒI";
        const comms = STATE.comments.filter(c => c.ParentID === id);
        b.innerHTML = `
            <div id="chat-history" style="height:350px; overflow-y:auto; border:1px solid var(--glass); padding:15px; border-radius:12px; margin-bottom:20px; background:rgba(0,0,0,0.2)">
                ${comms.length === 0 ? '<div style="color:var(--text-dim); text-align:center; margin-top:150px">Không có lịch sử thảo luận. Hãy bắt đầu cuộc trò chuyện.</div>' :
                comms.map(c => `
                    <div style="margin-bottom:15px; animation:fadeIn 0.3s">
                        <div style="font-size:0.7rem; color:var(--accent-cyan); display:flex; justify-content:space-between">
                            <span>${c.NguoiDung}</span>
                            <span style="color:var(--text-dim)">${new Date(c.ThoiGian).toLocaleString()}</span>
                        </div>
                        <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:12px 12px 12px 0; display:inline-block; margin-top:5px; color:#fff; font-size:0.9rem; max-width:90%">${c.NoiDung}</div>
                    </div>`).join('')}
            </div>
            <textarea id="val1" placeholder="Nhập nội dung thảo luận..." style="height:60px;"></textarea>
        `;
        setTimeout(() => { const ch = document.getElementById('chat-history'); if (ch) ch.scrollTop = ch.scrollHeight; }, 100);
    }

    function exportToCSV(data, filename) {
        if (!data || data.length === 0) { showToast('Không có dữ liệu để xuất.', 'warning'); return; }
        const headers = Object.keys(data[0]);
        const csv = [headers.join(','), ...data.map(row => headers.map(h => `"${row[h] || ''}"`).join(','))].join('\n');
        const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `${filename}_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
        showToast('Dữ liệu đã được xuất thành công.');
    }

    function renderKanban() {
        const statuses = [
            { id: 'Pending', name: 'Đang chờ', color: 'var(--text-dim)' },
            { id: 'In Progress', name: 'Đang làm', color: 'var(--accent-cyan)' },
            { id: 'Done', name: 'Hoàn tất', color: 'var(--accent-lime)' }
        ];
        let html = `<div class="kanban-board">`;
        statuses.forEach(st => {
            const items = STATE.tasks.filter(t => t.TrangThai === st.id);
            html += `
            <div class="kanban-col">
                <div class="status-badge" style="color:${st.color}">${st.name}</div>
                <div class="task-list">
                    ${items.map(t => {
                const project = STATE.projects.find(p => p.ID === t.ProjectID);
                return `<div class="task-card">
                            <div style="font-size:0.65rem; color:var(--accent-cyan); margin-bottom:5px">#${project ? project.Ten : 'N/A'}</div>
                            <div style="font-weight:600; color:#fff; margin-bottom:5px">${t.Ten}</div>
                            <div style="display:flex; justify-content:space-between; font-size:0.75rem; color:var(--text-dim)">
                                <span><i class="fas fa-user-circle"></i> ${t.NguoiLam}</span>
                                <span>${t.UuTien}</span>
                            </div>
                        </div>`
            }).join('')}
                    <button class="btn-ghost" style="width:100%; border:1px dashed rgba(255,255,255,0.1); padding:10px; border-radius:10px; font-size:0.7rem;" onclick="openModal('task')">+ THÊM NHIỆM VỤ</button>
                </div>
            </div>`;
        });
        document.getElementById('content-area').innerHTML = html + "</div>";
    }

    function renderGanttChart(projectId) {
        const p = STATE.projects.find(x => x.ID === projectId);
        const tasks = STATE.tasks.filter(t => t.ProjectID === projectId);
        const title = document.getElementById('page-title');
        title.innerHTML = `<i class="fas fa-arrow-left" onclick="viewProjectDetail('${projectId}')" style="cursor:pointer; margin-right:15px"></i> GANTT: ${p.Ten}`;

        // Get date range
        const dates = tasks.filter(t => t.Deadline).map(t => new Date(t.Deadline));
        if (p.BatDau) dates.push(new Date(p.BatDau));
        if (p.KetThuc) dates.push(new Date(p.KetThuc));

        const minDate = dates.length > 0 ? new Date(Math.min(...dates)) : new Date();
        const maxDate = dates.length > 0 ? new Date(Math.max(...dates)) : new Date();
        minDate.setDate(minDate.getDate() - 2);
        maxDate.setDate(maxDate.getDate() + 5);
        const totalDays = Math.max(1, (maxDate - minDate) / (1000 * 60 * 60 * 24));

        document.getElementById('content-area').innerHTML = `
            <div class="neon-card stagger-item">
                <div class="stat-label" style="margin-bottom:30px">TIẾN ĐỘ NHIỆM VỤ (THEO DÕI THỜI GIAN THỰC)</div>
                <div class="gantt-container">
                    ${tasks.map(t => {
            const tDate = t.Deadline ? new Date(t.Deadline) : new Date();
            const offset = ((tDate - minDate) / (1000 * 60 * 60 * 24) / totalDays) * 100;
            const duration = 15; // Placeholder duration
            return `
                            <div class="gantt-row">
                                <div class="gantt-label">${t.Ten}</div>
                                <div class="gantt-bar-bg">
                                    <div class="gantt-bar" style="left:${Math.max(0, offset - 5)}%; width:${duration}%; background:${t.TrangThai === 'Done' ? 'var(--accent-lime)' : 'var(--accent-cyan)'}"></div>
                                </div>
                            </div>`;
        }).join('') || '<div style="color:var(--text-dim); text-align:center">Chưa có nhiệm vụ nào được phân phối trên dòng thời gian.</div>'}
                </div>
            </div>
        `;
    }

    function renderLogs() {
        document.getElementById('content-area').innerHTML = `
            <div class="neon-card stagger-item">
                <div style="display:flex; justify-content:space-between; margin-bottom:20px">
                    <div class="stat-label">HỆ THỐNG TRUY XUẤT NHẬT KÝ</div>
                    <button class="btn-ghost" onclick="loadData()">LÀM MỚI DỮ LIỆU</button>
                </div>
                <div id="log-list">
                    ${STATE.logs.map(log => `
                        <div class="log-entry">
                            <span class="log-time">${log.ThoiGian}</span>
                            <span class="log-action" style="color:${log.HanhDong === 'CREATE' ? 'var(--accent-lime)' : (log.HanhDong === 'DELETE' ? 'var(--accent-magenta)' : 'var(--accent-cyan)')}">${log.HanhDong}</span>
                            <span class="log-detail">${log.ChiTiet}</span>
                        </div>
                    `).join('') || '<div style="padding:20px; text-align:center; color:var(--text-dim)">Không có nhật ký hệ thống.</div>'}
                </div>
            </div>`;
    }

    function renderReports() {
        const totalCreditsInput = STATE.finance.filter(f => f.Loai === 'Thu').reduce((sum, f) => sum + Number(f.SoTien), 0);
        const totalCreditsOutput = STATE.finance.filter(f => f.Loai === 'Chi').reduce((sum, f) => sum + Number(f.SoTien), 0);

        document.getElementById('content-area').innerHTML = `
            <div class="stats-container">
                <div class="neon-card stagger-item">
                    <div class="stat-label">Tổng nguồn thu</div>
                    <div class="stat-val" style="color:var(--accent-lime)">${totalCreditsInput.toLocaleString()} Ȼ</div>
                </div>
                <div class="neon-card stagger-item">
                    <div class="stat-label">Tổng nguồn chi</div>
                    <div class="stat-val" style="color:var(--accent-magenta)">${totalCreditsOutput.toLocaleString()} Ȼ</div>
                </div>
                <div class="neon-card stagger-item">
                    <div class="stat-label">Số dư hệ thống</div>
                    <div class="stat-val" style="color:var(--accent-cyan)">${(totalCreditsInput - totalCreditsOutput).toLocaleString()} Ȼ</div>
                </div>
            </div>
            <div class="neon-card stagger-item">
                <div class="stat-label" style="margin-bottom:20px">Dự Án Đang Chạy</div>
                <table class="neon-table">
                    <thead><tr><th>Tên Dự Án</th><th>Quản Lý</th><th>Trạng Thái</th><th>Tiến Độ</th></tr></thead>
                    <tbody>
                        ${STATE.projects.filter(p => p.TrangThai !== 'Hoàn tất').map(p => `
                            <tr>
                                <td>${p.Ten}</td>
                                <td>${p.QuanLy}</td>
                                <td>${p.TrangThai}</td>
                                <td>${p.TienDo}%</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }

    function generateGlobalReport() {
        showToast("Đang khởi tạo bản giải mã nhiệm vụ...");
        setTimeout(() => {
            window.print();
        }, 1000);
    }

    // --- THEME ENGINE ---
    function openThemePicker() {
        document.getElementById('modal').style.display = 'flex';
        const h = document.getElementById('modal-heading');
        const b = document.getElementById('modal-body');
        const btnSave = document.getElementById('btn-save');

        h.innerText = "MA TRẬN GIAO DIỆN: CHỌN CHỦ ĐỀ";
        btnSave.style.display = 'none';

        const themes = [
            { name: 'Xanh Neon', cyan: '#00c3ff', mag: '#ff0055' },
            { name: 'Cổ Điển', cyan: '#fdee06', mag: '#ff00ff' },
            { name: 'Rừng Xanh', cyan: '#00ff88', mag: '#8800ff' },
            { name: 'Vũ Trụ', cyan: '#7b61ff', mag: '#00d1ff' },
            { name: 'Hỏa Ngục', cyan: '#ff9500', mag: '#ff0033' }
        ];

        b.innerHTML = `
            <div class="stat-label">CHỌN TỔ HỢP MÀU SẮC HỆ THỐNG</div>
            <div class="theme-grid">
                ${themes.map(t => `
                    <div class="theme-item" style="background:linear-gradient(135deg, ${t.cyan}, ${t.mag}); color:#000" onclick="applyTheme('${t.cyan}', '${t.mag}')">
                        ${t.name}
                    </div>
                `).join('')}
            </div>
            <div style="margin-top:30px">
                <div class="stat-label">MÀU CHỦ ĐẠO 1</div>
                <input type="color" onchange="applyTheme(this.value, null)" style="height:50px; cursor:pointer">
                <div class="stat-label">MÀU CHỦ ĐẠO 2</div>
                <input type="color" onchange="applyTheme(null, this.value)" style="height:50px; cursor:pointer">
            </div>
        `;
    }

    function applyTheme(cyan, mag) {
        if (cyan) document.documentElement.style.setProperty('--accent-cyan', cyan);
        if (mag) document.documentElement.style.setProperty('--accent-magenta', mag);
        localStorage.setItem('afs_theme_cyan', cyan || getComputedStyle(document.documentElement).getPropertyValue('--accent-cyan'));
        localStorage.setItem('afs_theme_mag', mag || getComputedStyle(document.documentElement).getPropertyValue('--accent-magenta'));
        showToast("Giao diện đã được cập nhật thành công.");
    }

    // Load saved theme
    (function () {
        const c = localStorage.getItem('afs_theme_cyan');
        const m = localStorage.getItem('afs_theme_mag');
        if (c) document.documentElement.style.setProperty('--accent-cyan', c);
        if (m) document.documentElement.style.setProperty('--accent-magenta', m);
    })();

    function renderFinance() {
        let html = `<div class="neon-card stagger-item"><table class="neon-table">
            <thead><tr><th>Mô tả nội dung</th><th>Số tín dụng (Ȼ)</th><th>Loại</th><th>Vòng đời</th><th>Liên kết</th></tr></thead>
            <tbody>
            ${STATE.finance.map(f => `
                <tr>
                    <td style="color:#fff">${f.NoiDung}</td>
                    <td style="color:${f.Loai === 'Thu' ? 'var(--accent-lime)' : 'var(--accent-magenta)'}">${Number(f.SoTien).toLocaleString()} Ȼ</td>
                    <td><span style="border:1px solid ${f.Loai === 'Thu' ? 'var(--accent-lime)' : 'var(--accent-magenta)'}; padding:2px 6px; border-radius:4px; font-size:0.7rem; color:${f.Loai === 'Thu' ? 'var(--accent-lime)' : 'var(--accent-magenta)'}">${f.Loai}</span></td>
                    <td style="color:var(--text-dim)">${f.Ngay}</td>
                    <td style="color:var(--accent-cyan)">${f.DoiTuong || 'General'}</td>
                </tr>`).join('')}
            </tbody>
        </table></div>`;
        document.getElementById('content-area').innerHTML = html;
    }

    function renderAssets() {
        let html = `<div class="neon-card stagger-item"><table class="neon-table">
            <thead><tr><th>Tên tài sản</th><th>Số lượng</th><th>Giá trị</th><th>Tình trạng</th></tr></thead>
            <tbody>
            ${STATE.assets.map(a => `
                <tr>
                    <td style="color:#fff; font-weight:600;">${a.TenTS}</td>
                    <td>${a.SoLuong}</td>
                    <td>${Number(a.GiaTri).toLocaleString()}</td>
                    <td><span style="color:var(--accent-cyan)">${a.TinhTrang}</span></td>
                </tr>`).join('')}
            </tbody>
        </table></div>`;
        document.getElementById('content-area').innerHTML = html;
    }

    function renderClients() {
        let html = `<div class="neon-card stagger-item"><table class="neon-table">
            <thead><tr><th>Thực thể đối tác</th><th>Liên lạc</th><th>Email/Vector</th><th>Ghi chú</th></tr></thead>
            <tbody>
            ${STATE.clients.map(c => `
                <tr>
                    <td style="color:#fff; font-weight:600;">${c.TenKH}</td>
                    <td>${c.LienHe}</td>
                    <td style="color:var(--accent-cyan)">${c.Email}</td>
                    <td style="color:var(--text-dim)">${c.GhiChu}</td>
                </tr>`).join('')}
            </tbody>
        </table></div>`;
        document.getElementById('content-area').innerHTML = html;
    }

    function renderUsers() {
        let html = `<div class="neon-card stagger-item"><table class="neon-table">
            <thead><tr><th>Nhân sự</th><th>Vùng truy cập</th><th>Vai trò hệ thống</th></tr></thead>
            <tbody>
            ${STATE.users.map(u => `
                <tr>
                    <td style="display:flex; align-items:center; gap:10px">
                        <img src="${u.Avatar}" style="width:30px; height:30px; border-radius:6px; border:1px solid var(--accent-cyan)">
                        <span style="color:#fff">${u.Ten}</span>
                    </td>
                    <td style="color:var(--text-dim)">${u.Email}</td>
                    <td><span style="border:1px solid var(--accent-magenta); color:var(--accent-magenta); padding:2px 8px; border-radius:4px; font-size:0.7rem">${u.VaiTro}</span></td>
                </tr>`).join('')}
            </tbody>
        </table></div>`;
        document.getElementById('content-area').innerHTML = html;
    }

    // 5. MODAL & SAVE (Tối ưu cho PM)
    function openModal(type, idOrPid = null, isEdit = false) {
        currentType = type;
        currentEditId = isEdit ? idOrPid : null;
        document.getElementById('modal').style.display = 'flex';
        const h = document.getElementById('modal-heading');
        const b = document.getElementById('modal-body');
        const btnSave = document.getElementById('btn-save');
        btnSave.innerText = isEdit ? "CẬP NHẬT ĐƠN VỊ" : "KHỞI TẠO ĐƠN VỊ";

        let item = {};
        if (isEdit) {
            if (type === 'project') item = STATE.projects.find(x => x.ID === idOrPid);
            else if (type === 'task') item = STATE.tasks.find(x => x.ID === idOrPid);
        }

        if (type === 'project') {
            h.innerText = isEdit ? "CẤU HÌNH BLUEPRINT" : "KHỞI TẠO BLUEPRINT";
            b.innerHTML = `
                <div class="stat-label">TÊN BLUEPRINT</div><input id="val1" value="${item.Ten || ''}">
                <div class="stat-label">NGƯỜI QUẢN LÝ</div><input id="val2" value="${item.QuanLy || ''}">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px">
                    <div><div class="stat-label">NGÀY BẮT ĐẦU</div><input id="val3" type="date" value="${item.BatDau || ''}"></div>
                    <div><div class="stat-label">NGÀY KẾT THÚC</div><input id="val4" type="date" value="${item.KetThuc || ''}"></div>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px">
                    <div><div class="stat-label">TRẠNG THÁI</div><select id="val5">
                        <option value="Mới" ${item.TrangThai === 'Mới' ? 'selected' : ''}>Mới</option>
                        <option value="Đang làm" ${item.TrangThai === 'Đang làm' ? 'selected' : ''}>Đang làm</option>
                        <option value="Hoàn tất" ${item.TrangThai === 'Hoàn tất' ? 'selected' : ''}>Hoàn tất</option>
                        <option value="Tạm dừng" ${item.TrangThai === 'Tạm dừng' ? 'selected' : ''}>Tạm dừng</option>
                    </select></div>
                    <div><div class="stat-label">TIẾN ĐỘ (%)</div><input id="val6" type="number" value="${item.TienDo || 0}"></div>
                </div>
                <div class="stat-label">TÓM TẮT NHIỆM VỤ</div><textarea id="val7" style="height:60px">${item.MoTa || ''}</textarea>
                <div class="stat-label">LINK TÀI LIỆU</div><input id="val8" placeholder="https://..." value="${item.TaiLieu || ''}">`;
        } else if (type === 'task') {
            h.innerText = "PHÂN CÔNG NHIỆM VỤ";
            let parentPid = isEdit ? item.ProjectID : idOrPid;
            let ops = STATE.projects.map(p => `<option value="${p.ID}" ${parentPid === p.ID ? 'selected' : ''}>${p.Ten}</option>`).join('');
            b.innerHTML = `
                <div class="stat-label">TÊN NHIỆM VỤ</div><input id="val1" value="${item.Ten || ''}">
                <div class="stat-label">THUỘC BLUEPRINT</div><select id="val2">${ops}</select>
                <div class="stat-label">NHÂN SỰ THỰC HIỆN</div><input id="val3" value="${item.NguoiLam || ''}">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px">
                    <div><div class="stat-label">TRẠNG THÁI</div><select id="val4">
                        <option value="Pending" ${item.TrangThai === 'Pending' ? 'selected' : ''}>Đang chờ</option>
                        <option value="In Progress" ${item.TrangThai === 'In Progress' ? 'selected' : ''}>Đang làm</option>
                        <option value="Done" ${item.TrangThai === 'Done' ? 'selected' : ''}>Hoàn tất</option>
                    </select></div>
                    <div><div class="stat-label">MỨC ƯU TIÊN</div><select id="val5">
                        <option ${item.UuTien === 'Cao' ? 'selected' : ''}>Cao</option>
                        <option ${item.UuTien === 'Trung bình' ? 'selected' : ''}>Trung bình</option>
                        <option ${item.UuTien === 'Thấp' ? 'selected' : ''}>Thấp</option>
                    </select></div>
                </div>
                <div class="stat-label">THỜI HẠN (DEADLINE)</div><input id="val6" type="date" value="${item.Deadline || ''}">
                <div class="stat-label">LINK TÀI LIỆU CÔNG VIỆC</div><input id="val7" placeholder="https://..." value="${item.TaiLieu || ''}">`;
        } else if (type === 'comment') {
            // Handled by openChatModal
        } else if (type === 'finance') {
            h.innerText = "GHI CHÚ TÀI CHÍNH";
            let pOps = `<option value="Chung">Chung (Tổng hợp)</option>` + STATE.projects.map(p => `<option value="${p.Ten}">${p.Ten}</option>`).join('');
            b.innerHTML = `<input id="val1" placeholder="Mô tả nội dung chi/thu"><input id="val2" type="number" placeholder="Số tín dụng (Ȼ)"><select id="val3"><option>Chi</option><option>Thu</option></select><input id="val4" type="date"><select id="val5">${pOps}</select>`;
        } else {
            h.innerText = type === 'asset' ? "GHI CHÚ TÀI SẢN" : "GHI CHÚ THỰC THỂ";
            b.innerHTML = `<input id="val1" placeholder="Tên gọi"><input id="val2" placeholder="Giá trị/Liên lạc"><input id="val3" placeholder="Ghi chú thêm"><input id="val4" type="date">`;
        }
    }

    function closeModal() { document.getElementById('modal').style.display = 'none'; }

    function saveData() {
        const btn = document.getElementById('btn-save');
        btn.innerHTML = '<i class="fas fa-sync fa-spin"></i> ĐANG ĐỒNG BỘ...';

        let data = { ID: currentEditId };
        if (currentType === 'comment') {
            data = { ParentID: currentEditId, NguoiDung: STATE.user ? STATE.user.name : 'Unknown', NoiDung: val1.value, ThoiGian: new Date().toISOString() };
        } else if (currentType === 'project') data = { ...data, Ten: val1.value, QuanLy: val2.value, BatDau: val3.value, KetThuc: val4.value, TrangThai: val5.value, TienDo: val6.value, MoTa: val7.value, TaiLieu: val8.value };
        else if (currentType === 'task') data = { ...data, Ten: val1.value, ProjectID: val2.value, NguoiLam: val3.value, TrangThai: val4.value, UuTien: val5.value, Deadline: val6.value, TaiLieu: val7.value };
        else if (currentType === 'finance') data = { ...data, NoiDung: val1.value, SoTien: val2.value, Loai: val3.value, Ngay: val4.value, DoiTuong: val5.value };
        else if (currentType === 'asset') data = { ...data, TenTS: val1.value, SoLuong: 1, GiaTri: val2.value, NgayNhap: val4.value, TinhTrang: val3.value };
        else if (currentType === 'client') data = { ...data, TenKH: val1.value, LienHe: val2.value, Email: val3.value, GhiChu: val4.value };

        google.script.run.withSuccessHandler(newData => {
            STATE = { ...STATE, ...newData };
            if (currentType === 'task' && data.ProjectID) updateProjectProgress(data.ProjectID);
            showToast(`Đã đồng bộ ${currentType.toUpperCase()} thành công.`);
            if (currentType === 'comment') openChatModal(currentEditId);
            else {
                closeModal();
                if (CURRENT_PROJECT_ID) viewProjectDetail(CURRENT_PROJECT_ID);
                else switchPage(CURRENT_PAGE);
            }
            btn.innerText = "ĐỒNG BỘ DỮ LIỆU";
        }).saveData(currentType, data);
    }
</script>